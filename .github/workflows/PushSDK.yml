name: Release to Maven Central

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: maven

      # 1) 可见性检查（不泄露内容，仅判断是否已设置）
      - name: Check secrets presence
        run: |
          [ -z "${{ secrets.GPG_PRIVATE_KEY }}" ] && echo "GPG_PRIVATE_KEY is EMPTY" && exit 1 || echo "GPG_PRIVATE_KEY is SET"
          [ -z "${{ secrets.CENTRAL_USERNAME }}" ] && echo "CENTRAL_USERNAME is EMPTY" && exit 1 || echo "CENTRAL_USERNAME is SET"
          [ -z "${{ secrets.CENTRAL_TOKEN }}" ] && echo "CENTRAL_TOKEN is EMPTY" && exit 1 || echo "CENTRAL_TOKEN is SET"
          # 口令可为空（若你的私钥无口令），这里仅提示
          [ -z "${{ secrets.GPG_PASSPHRASE }}" ] && echo "GPG_PASSPHRASE is EMPTY (OK if your key has no passphrase)" || echo "GPG_PASSPHRASE is SET"

      # 2) 导入 GPG 私钥，开启 loopback，打印 key 列表用于确认（不暴露私钥）
      - name: Import GPG private key and list
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpgconf --kill gpg-agent || true
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          echo "== GPG version =="
          gpg --version
          echo "== Secret keys in keyring =="
          gpg --batch --list-secret-keys --keyid-format LONG

      # 3) 生成临时 settings.xml（使用 Central 的专用 username/password）
      - name: Create temporary Maven settings.xml
        env:
          CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
          CENTRAL_TOKEN: ${{ secrets.CENTRAL_TOKEN }}
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<'EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>ossrh</id>
                <username>${env.CENTRAL_USERNAME}</username>
                <password>${env.CENTRAL_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF

      # 4) 确认非 SNAPSHOT 版本
      - name: Ensure release version
        run: |
          VERSION=$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive org.codehaus.mojo:exec-maven-plugin:3.5.0:exec)
          echo "Project version: $VERSION"
          if echo "$VERSION" | grep -qi SNAPSHOT; then
            echo "ERROR: version is SNAPSHOT. Please set a non-SNAPSHOT version before releasing."
            exit 1
          fi

      # 5) 先做一次详细日志的 verify，显式指定 keyname（从 keyring 自动抓第一把）
      - name: Verify with detailed logs (GPG)
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          KEY_ID=$(gpg --batch --list-secret-keys --keyid-format LONG | awk '/^sec/{print $2}' | cut -d'/' -f2 | head -n1)
          echo "Detected KEY_ID=$KEY_ID"
          if [ -z "$KEY_ID" ]; then echo "No secret key detected, abort."; exit 1; fi
          mvn -e -X -Dgpg.passphrase="$GPG_PASSPHRASE" -Dgpg.keyname="$KEY_ID" -DskipTests=true clean verify

      # 6) 签名并发布（deploy）
      - name: Build, sign and deploy
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          KEY_ID=$(gpg --batch --list-secret-keys --keyid-format LONG | awk '/^sec/{print $2}' | cut -d'/' -f2 | head -n1)
          mvn -B -U -Dgpg.passphrase="$GPG_PASSPHRASE" -Dgpg.keyname="$KEY_ID" clean deploy