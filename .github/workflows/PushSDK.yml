name: Release to Maven Central

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: maven

      # 可选：快速检查必需的 Secrets 是否存在（避免空跑）
      - name: Check required secrets
        run: |
          [ -z "${{ secrets.GPG_PRIVATE_KEY }}" ] && echo "GPG_PRIVATE_KEY is EMPTY" && exit 1 || echo "GPG_PRIVATE_KEY is SET"
          [ -z "${{ secrets.CENTRAL_USERNAME }}" ] && echo "CENTRAL_USERNAME is EMPTY" && exit 1 || echo "CENTRAL_USERNAME is SET"
          [ -z "${{ secrets.CENTRAL_TOKEN }}" ] && echo "CENTRAL_TOKEN is EMPTY" && exit 1 || echo "CENTRAL_TOKEN is SET"
          # 无口令的私钥也可用；此处仅提示
          [ -z "${{ secrets.GPG_PASSPHRASE }}" ] && echo "GPG_PASSPHRASE is EMPTY (OK if your key has no passphrase)" || echo "GPG_PASSPHRASE is SET"

      # 仅在 CI 导入私钥（你已把 private.asc 转成单行 base64 存在 GPG_PRIVATE_KEY）
      - name: Import GPG private key (base64)
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          set -e
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          printf "pinentry-mode loopback\n" >> ~/.gnupg/gpg.conf
          printf "allow-loopback-pinentry\n" >> ~/.gnupg/gpg-agent.conf
          gpgconf --kill gpg-agent || true

          echo "$GPG_PRIVATE_KEY" > "$RUNNER_TEMP/priv.b64"
          base64 -d "$RUNNER_TEMP/priv.b64" > "$RUNNER_TEMP/private.asc"

          gpg --batch --import "$RUNNER_TEMP/private.asc"
          echo "== Secret keys in keyring =="
          gpg --batch --list-secret-keys --keyid-format LONG || true

      # 仅在 CI 生成 settings.xml（开发者本地无需配置）
      - name: Create temporary Maven settings.xml (CI-only)
        env:
          CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
          CENTRAL_TOKEN: ${{ secrets.CENTRAL_TOKEN }}
        run: |
          mkdir -p ~/.m2
          {
            printf '<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">\n'
            printf '  <servers>\n'
            printf '    <server>\n'
            printf '      <id>ossrh</id>\n'
            printf '      <username>${env.CENTRAL_USERNAME}</username>\n'
            printf '      <password>${env.CENTRAL_TOKEN}</password>\n'
            printf '    </server>\n'
            printf '  </servers>\n'
            printf '</settings>\n'
          } > ~/.m2/settings.xml

      # 确认版本不是 SNAPSHOT（发布前置检查）
      - name: Ensure release version (non-SNAPSHOT)
        run: |
          VERSION=$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive org.codehaus.mojo:exec-maven-plugin:3.5.0:exec)
          echo "Project version: $VERSION"
          if echo "$VERSION" | grep -qi SNAPSHOT; then
            echo "ERROR: version is SNAPSHOT. Please set a release version."; exit 1; fi

      # 先 verify，便于排错；显式指定 KEYID（替换为你的 KEYID）
      - name: Verify with signing (detailed logs)
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          KEY_ID="6BFD927CC2352BD5"  # TODO: 替换为你的长 KEYID（保持一致）
          echo "Using KEY_ID=$KEY_ID"
          mvn -e -X -Dgpg.passphrase="$GPG_PASSPHRASE" -Dgpg.keyname="$KEY_ID" -DskipTests=true clean verify

      # 签名并发布到 OSSRH（Maven Central）
      - name: Build, sign and deploy
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          KEY_ID="6BFD927CC2352BD5"  # TODO: 同上
          mvn -B -U -Dgpg.passphrase="$GPG_PASSPHRASE" -Dgpg.keyname="$KEY_ID" clean deploy