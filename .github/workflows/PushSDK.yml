name: Release to Maven Central

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: maven

      # 1) 检查 Secrets 存在性（不打印敏感内容）
      - name: Check secrets presence
        run: |
          [ -z "${{ secrets.GPG_PRIVATE_KEY }}" ] && echo "GPG_PRIVATE_KEY is EMPTY" && exit 1 || echo "GPG_PRIVATE_KEY is SET"
          [ -z "${{ secrets.CENTRAL_USERNAME }}" ] && echo "CENTRAL_USERNAME is EMPTY" && exit 1 || echo "CENTRAL_USERNAME is SET"
          [ -z "${{ secrets.CENTRAL_TOKEN }}" ] && echo "CENTRAL_TOKEN is EMPTY" && exit 1 || echo "CENTRAL_TOKEN is SET"
          # 私钥无口令也可以；此处仅提示
          [ -z "${{ secrets.GPG_PASSPHRASE }}" ] && echo "GPG_PASSPHRASE is EMPTY (OK if your key has no passphrase)" || echo "GPG_PASSPHRASE is SET"

      # 2) 导入 GPG 私钥并列出（支持原文或 base64 包裹）
      - name: Import GPG private key and list
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          set -e
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          printf "pinentry-mode loopback\n" >> ~/.gnupg/gpg.conf
          printf "allow-loopback-pinentry\n" >> ~/.gnupg/gpg-agent.conf
          gpgconf --kill gpg-agent || true

          KEY_RAW_FILE="$RUNNER_TEMP/private_raw.asc"
          printf "%s" "$GPG_PRIVATE_KEY" > "$KEY_RAW_FILE"

          echo "== Try A: import raw file =="
          set +e
          gpg --batch --import "$KEY_RAW_FILE" 2> "$RUNNER_TEMP/import_err_raw.log"
          RC_RAW=$?
          set -e
          if [ $RC_RAW -ne 0 ]; then
            echo "Import raw failed with code $RC_RAW"
            echo "--- stderr ---"; cat "$RUNNER_TEMP/import_err_raw.log" || true; echo "--------------"
          fi

          if ! gpg --batch --list-secret-keys --keyid-format LONG | grep -q '^sec'; then
            echo "== Try B: import base64-decoded =="
            KEY_B64_FILE="$RUNNER_TEMP/private_b64_decoded.asc"
            set +e
            base64 -d "$KEY_RAW_FILE" > "$KEY_B64_FILE" 2> /dev/null
            RC_B64=$?
            set -e
            if [ $RC_B64 -eq 0 ] && [ -s "$KEY_B64_FILE" ]; then
              set +e
              gpg --batch --import "$KEY_B64_FILE" 2> "$RUNNER_TEMP/import_err_b64.log"
              RC_IMP_B64=$?
              set -e
              if [ $RC_IMP_B64 -ne 0 ]; then
                echo "Import base64-decoded failed with code $RC_IMP_B64"
                echo "--- stderr ---"; cat "$RUNNER_TEMP/import_err_b64.log" || true; echo "--------------"
              fi
            else
              echo "Base64 decode not applicable or produced empty content."
            fi
          fi

          echo "== GPG version =="; gpg --version
          echo "== Secret keys in keyring =="; gpg --batch --list-secret-keys --keyid-format LONG || true
          echo "== First/Last non-empty lines of provided secret =="
          FIRST_LINE=$(printf "%s" "$GPG_PRIVATE_KEY" | awk 'NF{print; exit}')
          LAST_LINE=$(printf "%s" "$GPG_PRIVATE_KEY" | awk 'NF{line=$0} END{print line}')
          echo "$FIRST_LINE"; echo "..."; echo "$LAST_LINE"


      # 3) 写入 Maven settings.xml（避免 heredoc 的 YAML 坑）
      - name: Create temporary Maven settings.xml
        env:
          CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
          CENTRAL_TOKEN: ${{ secrets.CENTRAL_TOKEN }}
        run: |
          mkdir -p ~/.m2
          {
            printf '<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">\n'
            printf '  <servers>\n'
            printf '    <server>\n'
            printf '      <id>ossrh</id>\n'
            printf '      <username>${env.CENTRAL_USERNAME}</username>\n'
            printf '      <password>${env.CENTRAL_TOKEN}</password>\n'
            printf '    </server>\n'
            printf '  </servers>\n'
            printf '</settings>\n'
          } > ~/.m2/settings.xml
          echo "== Generated ~/.m2/settings.xml =="
          sed -n '1,120p' ~/.m2/settings.xml

      # 4) 确认发布版本不是 SNAPSHOT
      - name: Ensure release version
        run: |
          VERSION=$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive org.codehaus.mojo:exec-maven-plugin:3.5.0:exec)
          echo "Project version: $VERSION"
          if echo "$VERSION" | grep -qi SNAPSHOT; then
            echo "ERROR: version is SNAPSHOT. Please set a non-SNAPSHOT version before releasing."
            exit 1
          fi

      # 5) 先 verify（详细日志），显式指定 keyname，便于定位问题
      - name: Verify with detailed logs (GPG)
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          KEY_ID=$(gpg --batch --list-secret-keys --keyid-format LONG | awk '/^sec/{print $2}' | cut -d'/' -f2 | head -n1)
          echo "Detected KEY_ID=$KEY_ID"
          if [ -z "$KEY_ID" ]; then echo "No secret key detected, abort."; exit 1; fi
          mvn -e -X -Dgpg.passphrase="$GPG_PASSPHRASE" -Dgpg.keyname="$KEY_ID" -DskipTests=true clean verify

      # 6) 签名并发布到 Central
      - name: Build, sign and deploy
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          KEY_ID=$(gpg --batch --list-secret-keys --keyid-format LONG | awk '/^sec/{print $2}' | cut -d'/' -f2 | head -n1)
          mvn -B -U -Dgpg.passphrase="$GPG_PASSPHRASE" -Dgpg.keyname="$KEY_ID" clean deploy